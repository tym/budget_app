{% extends 'base.html' %}

{% block content %}
<h2>Expenses</h2>

<!-- Modal for adding or editing an expense -->
<div id="expense-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="close-expense-modal">&times;</span>
        <form id="expense-form" method="POST" action="{{ url_for('expenses.manage_expenses') }}">
            <input type="hidden" name="expense-id" id="expense-id">

            <label for="expense-date">Date:</label>
            <input type="date" id="expense-date" name="expense-date" required>

            <label for="expense-description">Description:</label>
            <input type="text" id="expense-description" name="expense-description" required>

            <label for="expense-amount">Amount:</label>
            <input type="number" id="expense-amount" name="expense-amount" required>

            <!-- Category Field (with default categories) -->
            <label for="expense-category">Category:</label>
            <div class="dropdown">
                <input type="text" id="expense-category" name="expense-category" class="form-control" placeholder="Select or Type Category" required>
                <ul class="dropdown-menu" id="category-dropdown-menu"> <!-- No 'show' class initially -->
                    <!-- Default Categories -->
                    <li><a class="dropdown-item" href="#" data-value="Shopping">Shopping</a></li>
                    <li><a class="dropdown-item" href="#" data-value="Bills">Bills</a></li>
                    <li><a class="dropdown-item" href="#" data-value="Entertainment">Entertainment</a></li>
                    <li><a class="dropdown-item" href="#" data-value="Dining Out">Dining Out</a></li>
                    <!-- Add more categories as needed -->
                </ul>
            </div>

            <!-- Hidden input to store a new category if entered -->
            <input type="hidden" id="new-category" name="new-category">
            <!-- Associated Bill or Income Field (Dynamic) -->
            <label for="bill-select">Associated Bill or Income:</label>
            <div class="dropdown">
                <input type="text" id="bill-select" name="bill-id" class="form-control" placeholder="Select Bill or Income" required>
                <ul class="dropdown-menu" id="bill-dropdown-menu">
                    <!-- Default option for no association -->
                    <li><a class="dropdown-item" href="#" data-value="">None</a></li>

                    <!-- Dynamic Bills from the database -->
                    {% for entry in bills %}
                        <li><a class="dropdown-item" href="#" data-value="{{ entry.bill_id }}">Bill - {{ entry.due_day }} - {{ entry.name }} - ${{ entry.amount }}</a></li>
                    {% endfor %}

                    <!-- Dynamic Incomes from the database -->
                    {% for entry in incomes %}
                        <li><a class="dropdown-item" href="#" data-value="{{ entry.income_id }}">Income - {{ entry.start_date.strftime('%Y-%m-%d') }} - {{ entry.name }} - ${{ entry.amount }}</a></li>
                    {% endfor %}
                </ul>
            </div>

            <label for="cleared-checkbox">Cleared:</label>
            <input type="checkbox" id="cleared-checkbox" name="cleared-checkbox">

            <button type="submit" class="btn">Save Expense</button>
        </form>
    </div>
</div>

<!-- Table displaying expenses -->
<div class="table-container">
    <button class="btn" id="add-expense-btn"><i class="fas fa-plus"></i> Add Expense</button>
    <div class="table-details">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Assoc. Bill or Income</th>
                    <th>Cleared</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.date }}</td>
                    <td>{{ expense.description }}</td>
                    <td>{{ expense.amount }}</td>
                    <td>{{ expense.category }}</td>
                    <td>{{ expense.linked_name if expense.linked_name else 'None' }}</td>
                    <td>{{ 'Yes' if expense.cleared else 'No' }}</td>
                    <td>
                        <!-- Edit Button -->
                        <button class="edit-btn" onclick="openEditModal('{{ expense.expense_id }}', '{{ expense.description }}', {{ expense.amount }}, '{{ expense.category }}', '{{ expense.date }}', {{ expense.cleared|tojson }})">
                            <i class="fas fa-edit"></i>
                        </button>

                        <!-- Delete Button -->
                        <form method="POST" action="{{ url_for('expenses.delete_expense', expense_id=expense.expense_id) }}" style="display:inline;">
                            <button type="submit" class="btn delete-btn" onclick="return confirm('Are you sure you want to delete this expense?');">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// JavaScript to handle dropdown behavior
document.addEventListener("DOMContentLoaded", function () {
    const categoryInput = document.getElementById('expense-category');
    const categoryDropdownMenu = document.getElementById('category-dropdown-menu');
    const newCategoryInput = document.getElementById('new-category');

    // Toggle the dropdown menu visibility when clicking on the input field
    categoryInput.addEventListener('focus', function () {
        categoryDropdownMenu.classList.add('show'); // Show dropdown
    });

    // Add event listener to filter the dropdown options as the user types
    categoryInput.addEventListener('input', function () {
        const filter = categoryInput.value.toLowerCase();
        const items = categoryDropdownMenu.getElementsByTagName('li');

        // Loop through all list items and hide those that don't match the filter
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const itemText = item.textContent || item.innerText;
            item.style.display = itemText.toLowerCase().includes(filter) ? '' : 'none';
        }
    });

    // Add event listener for when the user selects a category
    categoryDropdownMenu.addEventListener('click', function (event) {
        if (event.target && event.target.matches('.dropdown-item')) {
            categoryInput.value = event.target.textContent; // Set input value to selected category
            newCategoryInput.value = event.target.getAttribute('data-value'); // Set hidden input value to selected category
            categoryDropdownMenu.classList.remove('show'); // Close dropdown after selection
        }
    });

    // If user enters a new category
    categoryInput.addEventListener('blur', function () {
        const categoryText = categoryInput.value.trim();
        if (categoryText && !categoryDropdownMenu.querySelector(`a[data-value="${categoryText}"]`)) {
            // User entered a new category that's not already in the dropdown
            // Update the hidden input with the new category
            newCategoryInput.value = categoryText;

            // Add the new category to the dropdown
            const newCategoryItem = document.createElement('li');
            newCategoryItem.innerHTML = `<a class="dropdown-item" href="#" data-value="${categoryText}">${categoryText}</a>`;
            categoryDropdownMenu.appendChild(newCategoryItem);
        }
    });

    // Close dropdown if clicked outside
    window.addEventListener('click', function (e) {
        if (!e.target.closest('.dropdown')) {
            categoryDropdownMenu.classList.remove('show');
        }
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const expenseModal = document.getElementById('expense-modal');
    const expenseBtn = document.getElementById('add-expense-btn');
    const closeExpenseModal = document.getElementById('close-expense-modal');
    const expenseForm = document.getElementById('expense-form');

    if (expenseBtn) {
        expenseBtn.addEventListener('click', () => {
            expenseForm.action = '{{ url_for("expenses.manage_expenses") }}'; // Reset to add new
            expenseModal.style.display = 'block';
        });
    }

    if (closeExpenseModal) {
        closeExpenseModal.addEventListener('click', () => expenseModal.style.display = 'none');
    }

    window.addEventListener('click', (event) => {
        if (event.target == expenseModal) {
            expenseModal.style.display = 'none';
        }
    });
});

function openEditModal(expenseId, description, amount, category, date, cleared) {
    // Fill the modal with the current expense data
    document.getElementById('expense-id').value = expenseId;
    document.getElementById('expense-description').value = description;
    document.getElementById('expense-amount').value = amount;
    document.getElementById('expense-category').value = category;
    document.getElementById('expense-date').value = date;
    document.getElementById('cleared-checkbox').checked = cleared;

    // Open the modal
    const expenseModal = document.getElementById('expense-modal');
    expenseModal.style.display = 'block';
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const billInput = document.getElementById('bill-select');
    const billDropdownMenu = document.getElementById('bill-dropdown-menu');

    // Add event listener to filter the dropdown options as the user types
    billInput.addEventListener('input', function () {
        const filter = billInput.value.toLowerCase();
        const items = billDropdownMenu.getElementsByTagName('li');

        // Loop through all list items and hide those that don't match the filter
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const itemText = item.textContent || item.innerText;
            item.style.display = itemText.toLowerCase().includes(filter) ? '' : 'none';
        }
    });

    // Add event listener for when the user selects a bill or income
    billDropdownMenu.addEventListener('click', function (event) {
        if (event.target && event.target.matches('.dropdown-item')) {
            billInput.value = event.target.textContent; // Set input value to selected bill/income
            billDropdownMenu.classList.remove('show'); // Close dropdown after selection
            document.getElementById('bill-select').value = event.target.getAttribute('data-value'); // Set hidden value
        }
    });

    // Toggle the dropdown menu visibility when clicking on the input field
    billInput.addEventListener('focus', function () {
        billDropdownMenu.classList.add('show');
    });

    // Close dropdown when clicking outside
    window.addEventListener('click', function (e) {
        if (!e.target.closest('.dropdown')) {
            billDropdownMenu.classList.remove('show');
        }
    });
});
</script>

{% endblock %}
